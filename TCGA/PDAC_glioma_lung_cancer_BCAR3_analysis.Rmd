---
title: "Analysis of BCAR3 expression in pancreatic cancer, glioma, and lung cancer cell lines"
output: 
  html_document: 
    fig_height: 7
    fig_width: 9
    theme: spacelab
    toc: yes
Author: Paul J. Myers
Date of creation: 4/02/2020
R version: 3.6.3
---

# Housekeeping Code
We load the necessary libraries for this script and clear the R workspace.

```{r  Load packages,message=FALSE}
### Load packages:
library(tidyverse)
library(ggthemes)
library(ggpubr)
library(jcolors)
library(ggsci)
library(cowplot)
library(plotly)
library(readxl)
library(RColorBrewer)
library(colorspace)
library(ggrepel)
library(Hmisc)
```

```{r Clear environment}
### Clear R workspace:
rm(list=ls())
```

```{r Check and set working directory}
### Check current working directory:
cwd <- getwd()
cwd 
### Set working directory:
setwd(cwd)
```
```{r Filtering functions for missing values}
### Filtering functions for cleaning missing values:
## Filter NA values:
not_all_na <- function(x) {!all(is.na(x))} # Function for finding columns that are NOT all NA values
all_na <- function(x) {all(is.na(x))} # Function for finding columns that ARE all NA values
```

# Load public data sets
## CCLE RNA-seq Data
We now load RNA-seq data from the Cancer Cell Line Encyclopedia (CCLE). (See https://depmap.org/portal/download/ and download the file "CCLE_expression.csv".) We are only interested in using the RNA-seq data for protein coding genes. Other data from the CCLE, including the CCLE's RPPA data and information on all of the cell lines in the CCLE (required for the code below) are also available for download from this portal. These data are supplied as log2-transformed, 1-shifted RSEM TPM values, denoted below as $x_{i,j}^{log}$:

$$x_{i,j}^{log}=log_2(TPM_{i,j}+1)$$

```{r Load CCLE cell line info, warning=FALSE}
##### Load cell line info:
## Path for cell line info:
fn.cells <- "CCLE_sample_info.csv" # Note, as written, this file has been stored one folder up from the current directory in which this notebook file resides -- remove the ../ if the data are in the same directory as this notebook

### Load info for cell lines:
cl.sum <- read.csv(fn.cells)   #Cell line summaries

## Desired cell line lineages:
panc.lin <- c("central_nervous_system","lung","pancreas")
cell.info <- which(cl.sum$lineage %in% panc.lin) %>% cl.sum[.,] # Info of cell lines of interest

a <- split(cell.info, with(cell.info, lineage), drop = TRUE)

## Pull out each specific cancer:
panc <- a$pancreas
glio <- a$central_nervous_system %>% split(., with(.,lineage_subtype)) %>% .$glioma
lung <- a$lung

rm(a)
```

And now load the CCLE RNA-seq data.

```{r Load CCLE RNA-seq data, warning=FALSE, message=F}
##### Load CCLE RNA-seq data: log2(TPM+1) values
## File path for CCLE RNA-seq data:
fn4 = "CCLE_RNAseq_gene_expression_TPM_log2.csv" # Note, as written, this file has been stored one folder up from the current directory in which this notebook file resides -- remove the ../ if the data are in the same directory as this notebook

### Load CCLE RNA-seq data:
ccle.rna <- read_csv(fn4, col_names=T)
ccle.genes <- colnames(ccle.rna)[-1] %>%
  gsub("\\ .*","",.) # Remove extraneous suffixes on gene names
colnames(ccle.rna) <- c("Cell.line", ccle.genes)
```

```{r ,message = F,warning=F}
## Get desired cell line data:
ccle.id.rna <- ccle.rna$Cell.line %>% as.character() # Get DepMap IDs from CCLE data

#### GLIOMA ####
## Pull out glioma cell line IDs, names, and data:
glio.ind.ccle.rna <- which(ccle.id.rna %in% glio$DepMap_ID) # Match glioma cell line DepMap IDs to DepMap IDs in data set
glio.id.ccle.rna <- ccle.id.rna[glio.ind.ccle.rna] # DepMap IDs in data set
glio.name.ccle.rna <- match(glio.id.ccle.rna, glio$DepMap_ID) %>%
  glio$stripped_cell_line_name[.] # Names

# Pull out the glioma data:
glio.ccle.rna <- ccle.rna[glio.ind.ccle.rna,] # mRNA expression
glio.ccle.rna$Cell.line <- glio.name.ccle.rna # Replace DepMap IDs with stripped cell line names
```

## CCLE RPPA Data
Reverse-phase protein array (RPPA) data from the CCLE can also be obtained from either the primary CCLE website or from the DepMap Portal.

```{r Load CCLE RPPA data, warning = F, message = F}
##### Load CCLE RPPA data: 
## File path for CCLE RPPA data:
fn5 = "CCLE_RPPA_20181003.csv" # Note, as written, this file has been stored one folder up from the current directory in which this notebook file resides -- remove the ../ if the data are in the same directory as this notebook

## Load CCLE RNA-seq data:
ccle.rppa <- read_csv(fn5, col_names=T)
ccle.ans <- colnames(ccle.rppa)[-1] %>% 
  gsub("\\_Caution.*","",.) # Remove extraneous "_Caution" suffixes on analyte names
colnames(ccle.rppa) <- c("Cell.line", ccle.ans)

## Get cell line names in RPPA data:
ccle.names.rppa <- ccle.rppa$Cell.line %>% as.character() # Get CCLE names from CCLE RPPA data

#### GLIOMA ####
## Pull out the glio IDs, names, and data:
glio.ind.ccle.rppa <- which(ccle.names.rppa %in% glio$CCLE_Name) # Match glio cell line DepMap IDs to DepMap IDs in data set
glio.names.ccle.rppa <- ccle.names.rppa[glio.ind.ccle.rppa] %>% 
  gsub("\\_.*","",.) # Cleaned (stripped) CCLE cell line names

## Pull out the glio data:
glio.ccle.rppa <- ccle.rppa[glio.ind.ccle.rppa,] # Data
glio.ccle.rppa$Cell.line <- glio.names.ccle.rppa # Replace DepMap IDs with stripped cell line names
```

## MCLP RPPA Data
RPPA data can also be obtained from the MD Anderson Cell Lines Project (MCLP). These data are available at https://tcpaportal.org/mclp/#/download. 

```{r Load MCLP RPPA data, message = FALSE, warning = FALSE}
##### Load MCLP RPPA data: 
## File path for MCLP RPPA data:
fn6 = "MCLP-v1.1-Level4.tsv" # Note, as written, this file has been stored one folder up from the current directory in which this notebook file resides -- remove the ../ if the data are in the same directory as this notebook

## Load MCLP RPPA data:
mclp.rppa <- read_tsv(fn6, col_names=T)
mclp.ans <- colnames(mclp.rppa)[-1] 
colnames(mclp.rppa)[1] <- "Cell.line"

### Get cell line names:
mclp.names.rppa <- mclp.rppa$Cell.line %>% as.character() # Get MCLP names from MCLP RPPA data

#### GLIOMA ####
## Pull out the glioma IDs, names, and data:
glio.ind.mclp.rppa <- which(mclp.names.rppa %in% glio$stripped_cell_line_name) # Match glioma cell line names in data set
glio.names.mclp.rppa <- mclp.names.rppa[glio.ind.mclp.rppa] %>% 
  gsub("\\_.*","",.) # MCLP cell line names

## Pull out the glioma data:
glio.mclp.rppa.raw <- mclp.rppa[glio.ind.mclp.rppa,] # Data with missing values intact
glio.mclp.rppa <- Filter(not_all_na, glio.mclp.rppa.raw) # Remove analytes (variables/columns) that are completely missing
colnames(glio.mclp.rppa) <- colnames(glio.mclp.rppa) %>% make.names # Make columns (analyte) names R-compatible
```
# PCA: RNA-seq data

```{r, warning=F,message=F}
## EMT genes:
emt_markers <- c(
  "CAV1", "IGFBP2", "KDR", "YAP1", "CDH3", 
  "FN1", "SERPINE1", "CHI3L1", "COL1A2", "COL1A1", 
  "PRKCA", "CTNNB1", "MTOR", "GSK3A", "GSK3B", "AKT1", "CHEK1", "PXN",
  "PTEN", "MAPK8", "SRC", "MAPK1", "BAX", "BAK1", "MET",
  "PDGFRA", "OLIG2", "SOX2"
  )

#### GLIOMA ####
rna_emt <- glio.ccle.rna[, emt_markers] %>% as.matrix()
rownames(rna_emt) <- glio.ccle.rna$Cell.line
### PCA:
pca_rna.emt <- rna_emt %>% 
  .[, colSums(is.na(.))==0] %>% 
  data.frame() %>% # Turn data to dataframe
  prcomp(center = TRUE, scale. = TRUE) # Perform PCA
load1 <- pca_rna.emt$rotation %>% # Loadings
  data.frame(Analyte = row.names(.), .)
score1 <- pca_rna.emt$x %>% # Scores
  data.frame(Cell.line = row.names(.), .)
var_exp1 <- summary(pca_rna.emt)$importance %>% # Variance explained per PC
  t() %>% data.frame()

### Plot PC1 and PC2:
lnsz <- 1.2
txt_nudgex <- 0.0
txt_nudgey <- 0.02
txt.lab_sz <- 2
ptsz <- 3
txt_alpha <- 0.8

# load1_plot <-
ggplot(data = load1) + 
  geom_hline(yintercept = 0, color = "#333333", linetype = "dashed", alpha = 0.7) +
  geom_vline(xintercept = 0, color = "#333333", linetype = "dashed", alpha = 0.7) +
  geom_point(
    size = ptsz,
    aes(
      x = PC1,
      y = PC2,
      color = PC3,
    )
  ) +
  geom_text_repel(
    size = txt.lab_sz*2.2,
    alpha = txt_alpha,
    aes(
      x = PC1,
      y = PC2,
      label = Analyte,
    )
  ) +
  scale_color_gradient2( # Custom color gradient for bars
    limits = c(-max(abs(load1$PC3)), max(abs(load1$PC3))),
    midpoint=0,
    low="#0033ff",
    mid="#cccccc",
    high="#ff3300",
    space ="Lab"
  ) +
  theme_cowplot() +
  theme(
    panel.background = element_rect(color = "#000000"),
  ) +
  labs(
    x = paste("PC1 (", round(100*var_exp1$Proportion.of.Variance[1],2), "% var. explained)", sep = ""),
    y = paste("PC2 (", round(100*var_exp1$Proportion.of.Variance[2],2), "% var. explained)", sep = ""),
    title = "CCLE RNA-seq: Glioma, EMT marker PCA loadings",
    color = paste("PC3 (", round(100*var_exp1$Proportion.of.Variance[3],2), "% var. explained)", sep = "")
  )
# ggsave("glioma-RNAseq_EMT-BCAR3-mRNA_PCA_loadings.pdf", width = 8, height = 5) # Save ggplot as an image
#ggsave("glioma-RNAseq_EMT-BCAR3-mRNA_PCA_loadings.png", width = 8, height = 5) # Save ggplot as an image

# ggsave("glioma-RNAseq-BCAR3-mRNA_PCA_scores.pdf", width = 8, height = 5) # Save ggplot as an image
#ggsave("glioma-RNAseq-BCAR3-mRNA_PCA_scores.png", width = 8, height = 5) # Save ggplot as an image

## Plot cumulative variance explained with each PC:
var_exp1.df <- cbind(var_exp1, "PC" = seq(1:nrow(var_exp1)))
ggplot(data = var_exp1.df) +
  geom_col(aes(x = PC, y = Cumulative.Proportion*100), color = "black", fill = "#ff6666", size = lnsz) +
  theme_cowplot(
    18,
    line_size = lnsz
  ) + 
  scale_x_discrete(
    limits = seq(1:nrow(var_exp1))
  ) +
  scale_y_continuous(
    # limits = c(NA, 0.5),
    # don't expand y scale at the lower end
    expand = expansion(mult = c(0, 0.05))
  ) +
  # theme(
  #   
  # )
  labs(
    title = "Cumulative Variance Explained",
    y = "% variance captured",
    x = "Number of PCs"
  )
#ggsave("glioma-RNAseq-BCAR3-mRNA_pctvarexp.png", width = 8, height = 5) # Save ggplot as an image
```


# PCA: RPPA data

## CCLE RPPA

```{r CCLE RPPA, warning=F,message=F}
## CCLE RPPA EMT marker names
emt_prots <- c("Fibronectin","Vim","Claudin","Collagen","beta.Cat","Cav",
               "EGFR",
               "Met",
               "NF.",
               # "AXL",
               "YAP","JNK","NFKB","STAT","SMAD","Akt","CD44",
               "MTOR", "CHK1", "PTEN", "BAX", "BAK", "HER3")
#### GLIOMA ####
glio.b3rna <- match(glio.ccle.rppa$Cell.line, glio.ccle.rna$Cell.line) %>% na.omit() %>% data.frame(Cell.line = glio.ccle.rna$Cell.line[.], BCAR3_mRNA = glio.ccle.rna$BCAR3[.]) %>% .[,-1]
glio.ccle.b3rna <- match(glio.b3rna$Cell.line, glio.ccle.rppa$Cell.line) %>% data.frame(glio.ccle.rppa[.,], glio.b3rna) %>% .[,-1]
glio.ccle.b3rna <- glio.ccle.b3rna %>% .[, colSums(is.na(.))==0]

store <- 0
for (i in 1:length(emt_prots)) {
  temp <- str_subset(colnames(glio.ccle.b3rna), emt_prots[i])
  store <- c(store, temp)
}
store[store == "STATHMIN"] <- 0
# store <- store[, colSums(is.na(store))==0] 

ccle_emt <- store[-1] %>%
  na.omit() %>% 
  match(colnames(glio.ccle.b3rna)) %>% # Use supplied (complete) CCLE data only
  na.omit() %>% 
  glio.ccle.b3rna[,.] %>%
  data.matrix()
rownames(ccle_emt) <- glio.ccle.b3rna$Cell.line

### PCA:
pca_ccle.emt <- ccle_emt %>% 
  .[, colSums(is.na(.))==0] %>% 
  data.frame() %>% # Turn data to dataframe
  prcomp(center = TRUE, scale. = TRUE) # Perform PCA
load1 <- pca_ccle.emt$rotation %>% # Loadings
  data.frame(Analyte = row.names(.), .)
score1 <- pca_ccle.emt$x %>% # Scores
  data.frame(Cell.line = row.names(.), .)
var_exp1 <- summary(pca_ccle.emt)$importance %>% # Variance explained per PC
  t() %>% data.frame()

### Plot PC1 and PC2 loadings and scores:
lnsz <- 1.2
txt_nudgex <- 0.0
txt_nudgey <- 0.02
txt.lab_sz <- 2
ptsz <- 3
txt_alpha <- 0.8

# load1_plot <-
ggplot(data = load1) + 
  geom_hline(yintercept = 0, color = "#333333", linetype = "dashed", alpha = 0.7) +
  geom_vline(xintercept = 0, color = "#333333", linetype = "dashed", alpha = 0.7) +
  geom_point(
    size = ptsz,
    aes(
      x = PC1,
      y = PC2,
      color = PC3,
    )
  ) +
  geom_text_repel(
    size = txt.lab_sz*2.2,
    alpha = txt_alpha,
    aes(
      x = PC1,
      y = PC2,
      label = Analyte,
    )
  ) +
  scale_color_gradient2( # Custom color gradient for bars
    limits = c(-max(abs(load1$PC3)), max(abs(load1$PC3))),
    midpoint=0,
    low="#0033ff",
    mid="#cccccc",
    high="#ff3300",
    space ="Lab"
  ) +
  theme_cowplot() +
  theme(
    panel.background = element_rect(color = "#000000"),
  ) +
  labs(
    x = paste("PC1 (", round(100*var_exp1$Proportion.of.Variance[1],2), "% var. explained)", sep = ""),
    y = paste("PC2 (", round(100*var_exp1$Proportion.of.Variance[2],2), "% var. explained)", sep = ""),
    title = "CCLE RPPA: Glioma PCA loadings",
    color = paste("PC3 (", round(100*var_exp1$Proportion.of.Variance[3],2), "% var. explained)", sep = "")
  )
# ggsave("glioma-CCLE-RPPA_EMT-BCAR3-mRNA_PCA_loadings.pdf", width = 8, height = 5) # Save ggplot as an image
#ggsave("glioma-CCLE-RPPA_EMT-BCAR3-mRNA_PCA_loadings.png", width = 8, height = 5) # Save ggplot as an image

## Plot cumulative variance explained with each PC:
var_exp1.df <- cbind(var_exp1, "PC" = seq(1:nrow(var_exp1)))
ggplot(data = var_exp1.df) +
  geom_col(aes(x = PC, y = Cumulative.Proportion*100), color = "black", fill = "#ff6666", size = lnsz) +
  theme_cowplot(
    18,
    line_size = lnsz
  ) + 
  scale_x_discrete(
    limits = seq(1:nrow(var_exp1))
  ) +
  scale_y_continuous(
    # limits = c(NA, 0.5),
    # don't expand y scale at the lower end
    expand = expansion(mult = c(0, 0.05))
  ) +
  # theme(
  #   
  # )
  labs(
    title = "Cumulative Variance Explained",
    y = "% variance captured",
    x = "Number of PCs"
  )
#ggsave("glioma-CCLE-RPPA_EMT-BCAR3-mRNA_pctvarexp.png", width = 8, height = 5) # Save ggplot as an image
```
## MCLP RPPA
```{r}
#### Get EMT proteins in MCLP data set ####
emt_prots <- c("FIBRONECTIN","VIM","CLAUDIN7","COLLAGENVI","BETACAT","CAV",
               "EGFR",
               "MET",
               "YAP","JNK","NFKB","STAT","SMAD","AKT","CD44","PAI1", "SRC")

#### GLIOMA ####
glio.b3rna <- match(glio.mclp.rppa$Cell.line, glio.ccle.rna$Cell.line) %>% na.omit() %>% data.frame(Cell.line = glio.ccle.rna$Cell.line[.], BCAR3_mRNA = glio.ccle.rna$BCAR3[.]) %>% .[,-1]
glio.mclp.b3rna <- match(glio.b3rna$Cell.line, glio.mclp.rppa$Cell.line) %>% data.frame(glio.mclp.rppa[.,], glio.b3rna) %>% .[,-1]
glio.mclp.b3rna <- glio.mclp.b3rna %>% .[, colSums(is.na(.))==0]

store <- 0
for (i in 1:length(emt_prots)) {
  temp <- str_subset(colnames(glio.mclp.b3rna), emt_prots[i])
  store <- c(store, temp)
}
store[store == "STATHMIN"] <- 0
# store <- store[, colSums(is.na(store))==0] 

mclp_emt <- store[-1] %>%
  na.omit() %>% 
  match(colnames(glio.mclp.b3rna)) %>% # Use supplied (complete) MCLP data only
  na.omit() %>% 
  glio.mclp.b3rna[,.] %>%
  data.matrix()
rownames(mclp_emt) <- glio.mclp.b3rna$Cell.line

### PCA:
pca_mclp.emt <- mclp_emt %>% 
  .[, colSums(is.na(.))==0] %>% 
  data.frame() %>% # Turn data to dataframe
  prcomp(center = TRUE, scale. = TRUE) # Perform PCA
load1 <- pca_mclp.emt$rotation %>% # Loadings
  data.frame(Analyte = row.names(.), .)
score1 <- pca_mclp.emt$x %>% # Scores
  data.frame(Cell.line = row.names(.), .)
var_exp1 <- summary(pca_mclp.emt)$importance %>% # Variance explained per PC
  t() %>% data.frame()

### Plot PC1 and PC2:
lnsz <- 1.2
txt_nudgex <- 0.0
txt_nudgey <- 0.02
txt.lab_sz <- 2
ptsz <- 3
txt_alpha <- 0.8

# load1_plot <-
ggplot(data = load1) + 
  geom_hline(yintercept = 0, color = "#333333", linetype = "dashed", alpha = 0.7) +
  geom_vline(xintercept = 0, color = "#333333", linetype = "dashed", alpha = 0.7) +
  geom_point(
    size = ptsz,
    aes(
      x = PC1,
      y = PC2,
      color = PC3,
    )
  ) +
  geom_text_repel(
    size = txt.lab_sz*2.2,
    alpha = txt_alpha,
    aes(
      x = PC1,
      y = PC2,
      label = Analyte,
    )
  ) +
  scale_color_gradient2( # Custom color gradient for bars
    limits = c(-max(abs(load1$PC3)), max(abs(load1$PC3))),
    midpoint=0,
    low="#0033ff",
    mid="#cccccc",
    high="#ff3300",
    space ="Lab"
  ) +
  theme_cowplot() +
  theme(
    panel.background = element_rect(color = "#000000"),
  ) +
  labs(
    x = paste("PC1 (", round(100*var_exp1$Proportion.of.Variance[1],2), "% var. explained)", sep = ""),
    y = paste("PC2 (", round(100*var_exp1$Proportion.of.Variance[2],2), "% var. explained)", sep = ""),
    title = "MCLP RPPA: Glioma PCA loadings",
    color = paste("PC3 (", round(100*var_exp1$Proportion.of.Variance[3],2), "% var. explained)", sep = "")
  )
# ggsave("glioma-MCLP_EMT-BCAR3-mRNA_PCA_loadings.pdf", width = 8, height = 5) # Save ggplot as an image
#ggsave("glioma-MCLP_EMT-BCAR3-mRNA_PCA_loadings.png", width = 8, height = 5) # Save ggplot as an image

## Plot cumulative variance explained with each PC:
var_exp1.df <- cbind(var_exp1, "PC" = seq(1:nrow(var_exp1)))
ggplot(data = var_exp1.df) +
  geom_col(aes(x = PC, y = Cumulative.Proportion*100), color = "black", fill = "#ff6666", size = lnsz) +
  theme_cowplot(
    18,
    line_size = lnsz
  ) + 
  scale_x_discrete(
    limits = seq(1:nrow(var_exp1))
  ) +
  scale_y_continuous(
    # limits = c(NA, 0.5),
    # don't expand y scale at the lower end
    expand = expansion(mult = c(0, 0.05))
  ) +
  # theme(
  #   
  # )
  labs(
    title = "Cumulative Variance Explained",
    y = "% variance captured",
    x = "Number of PCs"
  )
#ggsave("glioma-MCLP_EMT-BCAR3-mRNA_pctvarexp.png", width = 8, height = 5) # Save ggplot as an image
```




# GSVA calculations

We're now going to perform GSVA on the RNA-seq data from the different sets of cell lines. See [here](https://dx.doi.org/10.1186%2F1471-2105-14-7) for the paper on GSVA and [here](https://www.bioconductor.org/packages/release/bioc/html/GSVA.html) for information on the GSVA package from Bioconductor.

```{r GSVA: load packages and gene sets, warning=FALSE, message=FALSE}
### Install packages if not done already:
# BiocManager::install(c("limma","GSVA","GSVAdata","org.Hs.eg.db","GSEABase","snow","rlecuyer","edgeR")) # Comment out this line if you've already installed these packages to your current R distribution.

### Load packages:
library(GSVA) # Gene set variation analysis package from Bioconductor --> This package contains a command that can perform four types of gene set enrichment analyses: GSVA, ssGSEA, PLAGE, and z-score.
library(org.Hs.eg.db)
library(GSEABase)
library(limma)
library(msigdbr)

### Start by putting data in .GCT format:
data_for_gsva <- panc.ccle.rna %>% as.matrix() %>% t() %>% .[-1,] # Pancreas cell lines
colnames(data_for_gsva) <- panc.ccle.rna$Cell.line

data_for_gsva2 <- lung.ccle.rna %>% as.matrix() %>% t() %>% .[-1,] # Lung cell lines
colnames(data_for_gsva2) <- lung.ccle.rna$Cell.line

data_for_gsva3 <- glio.ccle.rna %>% as.matrix() %>% t() %>% .[-1,] # Glioma cell lines
colnames(data_for_gsva3) <- glio.ccle.rna$Cell.line


## Convert gene names to Entrez IDs:
# entrez_ids <- comb$Ensembl_gene %>%  mapIds(org.Hs.eg.db, ., 'ENTREZID', 'ENSEMBL')
# rownames(data_for_gsva) <- entrez_ids

### Define MSigDB gene set collection(s) to use:
# gene_sets <- getGmt("../msigdb.v7.0.entrez.gmt") %>% # Load all GSEA/Broad MSigDB gene sets using ENtrez IDs --> download this file from the MSigDB website
gene_sets <- getGmt("../msigdb.v7.0.symbols.gmt") %>% # Load all GSEA/Broad MSigDB gene sets using gene symbols --> download this file from the MSigDB website
  .[grep("^HALLMARK_|^KEGG_|^CELL_|^REACTOME_|^PID_|^GO_|POSITIVE_REGULATION_OF_CELL_PROLIFERATION$|^BIOCARTA_|AIGNER_ZEB1|CHARAFE_BREAST",
         names(.))] # Pull curated gene sets by their database/primary identifier
```

```{r warning=F,message=F}
## Select key words to further subset the selected MSigDB gene set collection:
gs.kw <- c(
  # "REACTOME",
  # "BREAST",
  "RECEPTOR_TYROSINE_KINASES",
  "BY_EGFR",
  # "BY_ERBB2",
  # "BY_ERBB4",
  "PID_ERBB2_ERBB3",
  # "PID_ERBB_NETWORK",
  "PID_ERBB4",
  "PID_ERBB1_",
  "PID_ECADHERIN_STAB",
  "PID_TGBFR",
  "BY_MET",
  "BY_VEGF$",
  "BY_TGF_BETA",
  "KEGG_ADHER",
  "KEGG_CELL_ADHESION_MOLECULES_CAM",
  "KEGG_ERBB",
  "KEGG_MAPK",
  "KEGG_FOCAL_ADHESION",
  "GO_CELL_CELL_JUNCTION",
  "BIOCARTA_CELLCYCLE",

  "REACTOM_CELL_CELL_JUNCTION",
  "REACTOME_CELL_EXTRACELLULAR_MATRIX",
  # "REACTOME_NEGATIVE_REGULATION_OF_MAPK_PATHWAY",
  # "REACTOME_NEGATIVE_REGULATION_OF_MET_SIGNALING",
  # "REACTOME_NEGATIVE_REGULATION_OF_THE_PI3K_AKT_NETWORK",
  "REACTOME_NEGATIVE_REGULATION_OF",
  "ONCOGENIC_MAPK_SIGNALING",
  "RECEPTOR_TYPE_TYROSINE_PROTEIN_PHOS",
  # "REACTOME_ENDOSOMAL",
  "REACTOME_MITOTIC",
  "GO_CELL_CYCLE",
  # "^GO_POSITIVE_REGULATION_OF_EPITHELIAL_TO_MESENCHYMAL_TRANSITION$",
  "^GO_NEGATIVE_REGULATION_OF_EPITHELIAL_TO_MESENCHYMAL_TRANSITION$",
  # "GO_EPITHELIAL_TO_MESENCHYMAL_TRANSITION$",
  # "GO_MESENCHYMAL_TO_EPITHELIAL_TRANSITION$",
  "GO_ERBB_SIGNALING_PATHWAY$",

  "GO_MAP_KINASE_PHOSPHATASE_ACTIVITY",
  "GO_PROTEIN_TYROSINE_PHOSPHATASE_ACTIVITY",
  "GO_PROTEIN_SERINE_THREONINE_PHOSPHATASE_ACTIVITY",
  "GO_PHOSPHOPROTEIN_PHOSPHATASE_ACTIVITY",

  "CDC42_REG_PATHWAY",
  
  # "KEGG",
  # "REACTOME",
  # "BIOCARTA",
  # "PID",
  
  "ZEB1",
  
  "HALLMARK"
  )

## Now get the gene sets matching the above key words from the MSigDB list:
store <- 0
for (i in 1:length(gs.kw)) {
  temp <- str_subset(names(gene_sets), gs.kw[i])
  store <- c(store, temp)
}
## Remove gene sets that we don't want:
rem_patterns <- "SPERM|ADIPO|MYO|MEIOSIS|ALLOGRAFT|PANCREAS|CHOLESTEROL|ACID|METABOLISM|INTERFERON|APICAL|ESTROGEN|GLYCOLYSIS|COMPLEMENT|COAGULATION|UNFOLDED|PEROXISOME|E2F|OXIDATIVE|OXYGEN|ANDROGEN|HEME|XENO|VIII|KRAS|CELL_CYCLE|PHASE|UV|DNA|MITOTIC|G2|CANCER|TCF|TFAP2|NMDA|NOTCH4"
# rem_patterns <- "AAAAA"

store <- store[!grepl(rem_patterns, store)]

## Pull the gene sets we want:
gene.sets <- store[-1] %>% 
  na.omit() %>% 
  match(names(gene_sets)) %>% 
  na.omit() %>% unique() %>% 
  gene_sets[.]
  
### Calculate GSVA enrichment scores:
tn.gsva <- gsva( # Pancreas
  data_for_gsva, 
  gene.sets, 
  method="gsva", 
  parallel.sz=detectCores()-1
  )
tn.gsva2 <- gsva( # Lung
  data_for_gsva2, 
  gene.sets, 
  method="gsva", 
  parallel.sz=detectCores()-1
  )
tn.gsva3 <- gsva( # Glioma
  data_for_gsva3, 
  gene.sets, 
  method="gsva", 
  parallel.sz=detectCores()-1
  )
tn.gsva.df <- tn.gsva %>% data.frame(gene.set=rownames(.), .) # Convert to data frame
tn.gsva.df2 <- tn.gsva2 %>% data.frame(gene.set=rownames(.), .) # Convert to data frame
tn.gsva.df3 <- tn.gsva3 %>% data.frame(gene.set=rownames(.), .) # Convert to data frame

# tn.gsva.df$gene.set <- gsub(".*HALLMARK_|.*REACTOME_|.*PID_|.*KEGG_", "", tn.gsva.df$gene.set) #Unused:
rownames(tn.gsva.df) <- tn.gsva.df$gene.set
rownames(tn.gsva.df2) <- tn.gsva.df2$gene.set
rownames(tn.gsva.df3) <- tn.gsva.df3$gene.set

```

Now, let's visualize the enrichment score results from GSVA via a heatmap.

```{r Visualize GSVA Results, message=FALSE, warning=FALSE}
#### Visualize with heatmaply:
## Load packages:
library(heatmaply)

## Set color scheme for heat map:
# mycol <- brewer.pal(n=11, name="RdBu") %>% rev() # Color scheme for heatmap
# mycol <- colorRampPalette(c("#0000cc","#cccccc","#ff0000")) # Custom color scheme
mycol <- colorRampPalette(c("red","black","green")) # Custom color scheme

## Get data to plot for heatmap:
plotdata <- tn.gsva.df[,-1] %>% data.matrix()
rownames(plotdata) <- rownames(tn.gsva.df)

plotdata2 <- tn.gsva.df2[,-1] %>% data.matrix()
rownames(plotdata2) <- rownames(tn.gsva.df2)

plotdata3 <- tn.gsva.df3[,-1] %>% data.matrix()
rownames(plotdata) <- rownames(tn.gsva.df3)

### Generate heatmap:
nk_col <- 4
heatmaply(
  plotdata,
  k_col = nk_col, # How many column dendrogram clusters to color
  k_row = 8, # How many row dendrogram clusters to color
  limits = c(-max(abs(plotdata)),max(abs(plotdata))),
  # dist_method = "manhattan", # If NULL, Euclidean is used
  hclust_method = "ward.D2",
  # hclust_method = NA,
  # show_dendrogram = c(TRUE, FALSE), # Show row dendrogram only
  # show_dendrogram = c(FALSE, TRUE), # Show column dendrogam only
  show_dendrogram = c(TRUE, TRUE), # Show both dendrograms
  # show_dendrogram = c(FALSE, FALSE), # Show neither dendrogram
  branches_lwd = 0.3,
  colors=mycol,
  key.title="GSVA\nEnrichment Score",
  showticklabels = c(FALSE, TRUE), 
  cexCol = 1.3, # Scale size of column tick/label text
  cexRow = 0.8, # Scale size of row tick/label text
  column_text_angle = 45,
  # ylab = "Gene set",
  xlab = "Cell line",
  main = "GSVA of pancreatic cancer cell line RNA-seq",
  )

heatmaply(
  plotdata2,
  k_col = nk_col, # How many column dendrogram clusters to color
  k_row = 8, # How many row dendrogram clusters to color
  limits = c(-max(abs(plotdata2)),max(abs(plotdata2))),
  # dist_method = "manhattan", # If NULL, Euclidean is used
  hclust_method = "ward.D2",
  show_dendrogram = c(TRUE, TRUE), # Show both dendrograms
  branches_lwd = 0.3,
  # grid_color = "black",
  colors = mycol,
  key.title="GSVA\nEnrichment Score",
  showticklabels = c(FALSE, TRUE), 
  cexCol = 1.3, # Scale size of column tick/label text
  cexRow = 0.8, # Scale size of row tick/label text
  column_text_angle = 45,
  # ylab = "Gene set",
  xlab = "Cell line",
  main = "GSVA of lung cancer cell line RNA-seq",
  )

heatmaply(
  plotdata3,
  k_col = nk_col, # How many column dendrogram clusters to color
  k_row = 8, # How many row dendrogram clusters to color
  limits = c(-max(abs(plotdata3)),max(abs(plotdata3))),
  # dist_method = "manhattan", # If NULL, Euclidean is used
  hclust_method = "ward.D2",
  show_dendrogram = c(TRUE, TRUE), # Show both dendrograms
  branches_lwd = 0.3,
  # grid_color = "black",
  colors = mycol,
  key.title="GSVA\nEnrichment Score",
  showticklabels = c(FALSE, TRUE), 
  cexCol = 1.3, # Scale size of column tick/label text
  cexRow = 0.8, # Scale size of row tick/label text
  column_text_angle = 45,
  xlab = "Cell line",
  main = "GSVA of glioma cell line RNA-seq",
  )
```

```{r Calculate and plot ranks of GSVA ES scores to BCAR3 expression, message=F, warning=F}
## Plot options:
ptsize <- 3.5
ptshape <- 21
lnsz <- 1.2
txtsz <- 4

#### PANCREAS ####
## Prep data for calculating GSVA ES ranks to BCAR3 mRNA:
panc.b3 <- data_for_gsva["BCAR3",] %>% data.frame(BCAR3 = .) %>% t() %>% as.numeric()
b3.panc <- rbind(plotdata %>% data.frame(), panc.b3) %>% t()
colnames(b3.panc) <- c(rownames(plotdata), "BCAR3_mRNA")

## Calculate Spearman's Rs and p-values using Hmisc package:
rs.alpha <- 0.05 # Desired significance level to test
rs <- rcorr(b3.panc, type = "spearman") # Calculate ranks/correlations and p-values
rs.b3.panc <- data.frame(rs = rs$r[-which(rownames(rs$r) == "BCAR3_mRNA"), "BCAR3_mRNA"], # Spearman ranks of enrichment scores to BCAR3 mRNA
                    p = rs$P[-which(rownames(rs$P) == "BCAR3_mRNA"), "BCAR3_mRNA"], # P-values associated with Spearman ranks (is the observed rank significantly different from 0?)
                    gene.set = rownames(rs$P)[rownames(rs$P) != "BCAR3_mRNA"])
# rs.b3.panc$gene.set <- gsub(".*HALLMARK_|.*REACTOME_|.*KEGG_", "", rs.b3.panc$gene.set) 
rs.b3.panc <- rs.b3.panc %>%  .[order(.$rs, decreasing=T),]
rs.b3.panc$gene.set <- factor(rs.b3.panc$gene.set, levels=rs.b3.panc$gene.set)
rs.b3.panc$pyn <- rs.b3.panc$p > rs.alpha

### Plot Spearman's Rs:
# rs.plot <- 
ggplot(
  data = rs.b3.panc,
  # data = rs.b3[which(rs.b3$p<rs.alpha),],
  # data = b3.rs,
  aes(
    y = gene.set,
    x = rs,
    group = 1,
    label = gene.set,
    fill = pyn %>% as.numeric(),
    )
  ) + 
  geom_vline(xintercept = 0, color = "#999999") +
  # geom_line(size = lnsz, color = "black") +
  geom_point(shape = ptshape, size = ptsize, color = "black",
             # fill = "#999999",
             ) +
  # geom_text(
  #   angle = 0,
  #   nudge_x = 0.01,
  #   hjust = 0,
  #   size = txtsz
  #   ) +
  geom_text_repel(
    position = "dodge",
    size = txtsz-1,
    alpha = 0.9,
    max.overlaps = 1000,
    label.padding = 2,
    segment.size = 0.25,
    segment.alpha = .8,
    force = 1
  ) +
  scale_fill_continuous(
    high = "red", low = "green", breaks = rs.alpha
    )+
  theme_cowplot(
    18,
    line_size = lnsz
  ) + 
  scale_y_discrete(
    expand = expand_scale(mult = c(0.05, 0.05))
  ) +
  theme(
    axis.text.y = element_blank(),
    axis.line.y = element_blank(),
    axis.ticks.y = element_blank(),
    ) +
  labs(
    title = paste("GSVA enrichment score ranks to BCAR3 mRNA, pancreas cell lines", sep = ""),
    # y = "Gene set",
    y = "",
    x = "Spearman's Rs"
  ) +
  guides(
    fill = FALSE
  )
ggsave("PANCREAS_GSVA-ES_B3ranks.png", width = 12, height = 8)


#### LUNG ####
## Prep data for calculating GSVA ES ranks to BCAR3 mRNA:
lung.b3 <- data_for_gsva2["BCAR3",] %>% data.frame(BCAR3 = .) %>% t() %>% as.numeric()
b3.lung <- rbind(plotdata %>% data.frame(), lung.b3) %>% t()
colnames(b3.lung) <- c(rownames(plotdata2), "BCAR3_mRNA")

## Calculate Spearman's Rs and p-values using Hmisc package:
rs.alpha <- 0.05 # Desired significance level to test
rs <- rcorr(b3.lung, type = "spearman") # Calculate ranks/correlations and p-values
rs.b3.lung <- data.frame(rs = rs$r[-which(rownames(rs$r) == "BCAR3_mRNA"), "BCAR3_mRNA"], # Spearman ranks of enrichment scores to BCAR3 mRNA
                    p = rs$P[-which(rownames(rs$P) == "BCAR3_mRNA"), "BCAR3_mRNA"], # P-values associated with Spearman ranks (is the observed rank significantly different from 0?)
                    gene.set = rownames(rs$P)[rownames(rs$P) != "BCAR3_mRNA"])
# rs.b3.lung$gene.set <- gsub(".*HALLMARK_|.*REACTOME_|.*KEGG_", "", rs.b3.lung$gene.set) 
rs.b3.lung <- rs.b3.lung %>%  .[order(.$rs, decreasing=T),]
rs.b3.lung$gene.set <- factor(rs.b3.lung$gene.set, levels=rs.b3.lung$gene.set)
rs.b3.lung$pyn <- rs.b3.lung$p > rs.alpha

### Plot Spearman's Rs:
# rs.plot <- 
ggplot(
  data = rs.b3.lung,
  aes(
    y = gene.set,
    x = rs,
    group = 1,
    label = gene.set,
    fill = pyn %>% as.numeric(),
    )
  ) + 
  geom_vline(xintercept = 0, color = "#999999") +
  geom_point(shape = ptshape, size = ptsize, color = "black",
             # fill = "#999999",
             ) +
  geom_text_repel(
    position = "dodge",
    size = txtsz-1,
    alpha = 0.9,
    max.overlaps = 1000,
    label.padding = 2,
    segment.size = 0.25,
    segment.alpha = .8,
    force = 1
  ) +
  scale_fill_continuous(
    high = "red", low = "green", breaks = rs.alpha
    )+
  theme_cowplot(
    18,
    line_size = lnsz
  ) + 
  scale_y_discrete(
    expand = expand_scale(mult = c(0.05, 0.05))
  ) +
  theme(
    axis.text.y = element_blank(),
    axis.line.y = element_blank(),
    axis.ticks.y = element_blank(),
    ) +
  labs(
    title = paste("GSVA enrichment score ranks to BCAR3 mRNA, lung cell lines", sep = ""),
    # y = "Gene set",
    y = "",
    x = "Spearman's Rs"
  ) +
  guides(
    fill = FALSE
  )
ggsave("LUNG_GSVA-ES_B3ranks.png", width = 12, height = 8)


#### GLIOMA ####
## Prep data for calculating GSVA ES ranks to BCAR3 mRNA:
glio.b3 <- data_for_gsva3["BCAR3",] %>% data.frame(BCAR3 = .) %>% t() %>% as.numeric()
b3.glio <- rbind(plotdata %>% data.frame(), glio.b3) %>% t()
colnames(b3.glio) <- c(rownames(plotdata3), "BCAR3_mRNA")

## Calculate Spearman's Rs and p-values using Hmisc package:
rs.alpha <- 0.05 # Desired significance level to test
rs <- rcorr(b3.glio, type = "spearman") # Calculate ranks/correlations and p-values
rs.b3.glio <- data.frame(rs = rs$r[-which(rownames(rs$r) == "BCAR3_mRNA"), "BCAR3_mRNA"], # Spearman ranks of enrichment scores to BCAR3 mRNA
                    p = rs$P[-which(rownames(rs$P) == "BCAR3_mRNA"), "BCAR3_mRNA"], # P-values associated with Spearman ranks (is the observed rank significantly different from 0?)
                    gene.set = rownames(rs$P)[rownames(rs$P) != "BCAR3_mRNA"])
# rs.b3.glio$gene.set <- gsub(".*HALLMARK_|.*REACTOME_|.*KEGG_", "", rs.b3.glio$gene.set) 
rs.b3.glio <- rs.b3.glio %>%  .[order(.$rs, decreasing=T),]
rs.b3.glio$gene.set <- factor(rs.b3.glio$gene.set, levels=rs.b3.glio$gene.set)
rs.b3.glio$pyn <- rs.b3.glio$p > rs.alpha

### Plot Spearman's Rs:
# rs.plot <- 
ggplot(
  data = rs.b3.glio,
  aes(
    y = gene.set,
    x = rs,
    group = 1,
    label = gene.set,
    fill = pyn %>% as.numeric(),
    )
  ) + 
  geom_vline(xintercept = 0, color = "#999999") +
  geom_point(shape = ptshape, size = ptsize, color = "black",
             # fill = "#999999",
             ) +
  geom_text_repel(
    position = "dodge",
    size = txtsz-1,
    alpha = 0.9,
    max.overlaps = 1000,
    label.padding = 2,
    segment.size = 0.25,
    segment.alpha = .8,
    force = 1
  ) +
  scale_fill_continuous(
    high = "red", low = "green", breaks = rs.alpha
    )+
  theme_cowplot(
    18,
    line_size = lnsz
  ) + 
  scale_y_discrete(
    expand = expand_scale(mult = c(0.05, 0.05))
  ) +
  theme(
    axis.text.y = element_blank(),
    axis.line.y = element_blank(),
    axis.ticks.y = element_blank(),
    ) +
  labs(
    title = paste("GSVA enrichment score ranks to BCAR3 mRNA, glioma cell lines", sep = ""),
    # y = "Gene set",
    y = "",
    x = "Spearman's Rs"
  ) +
  guides(
    fill = FALSE
  )
ggsave("GLIOMA_GSVA-ES_B3ranks.png", width = 12, height = 8)

```



